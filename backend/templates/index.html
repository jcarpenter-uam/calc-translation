<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="dark light" />
    <title>Real-Time Viewer</title>
    <style>
      :root[data-theme="dark"] {
        --bg: #18181b;
        --surface: #27272a;
        --text-primary: #e4e4e7;
        --text-secondary: #a1a1aa;
        --border: #3f3f46;
        --status-connected: #10b981;
        --status-connecting: #f59e0b;
        --status-disconnected: #ef4444;
        --spinner-track: #3f3f46;
        --spinner-thumb: #a1a1aa;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
          Arial, sans-serif;
        margin: 0;
        background-color: var(--bg);
        color: var(--text-primary);
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .header-container {
        position: sticky;
        top: 0;
        background-color: var(--bg);
        z-index: 100;
        padding: 24px;
        border-bottom: 1px solid var(--border);
        width: 100%;
        text-align: center;
      }
      h1 {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0 0 16px 0;
      }
      .status-grid {
        display: flex;
        justify-content: center;
        gap: 24px;
        font-size: 0.875rem;
        color: var(--text-secondary);
      }
      .status-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        transition: background-color 0.3s ease;
      }
      .status-indicator.connecting {
        background-color: var(--status-connecting);
      }
      .status-indicator.connected {
        background-color: var(--status-connected);
      }
      .status-indicator.disconnected {
        background-color: var(--status-disconnected);
      }
      .transcript-container {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
      }
      #linesTranscript {
        margin: 0 auto;
        max-width: 720px;
        text-align: left;
      }

      .sentence-pair {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 0 12px;
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--border);
      }
      .sentence-pair:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }
      .speaker-name {
        grid-column: 1 / 2;
        font-weight: 600;
        color: var(--text-primary);
        white-space: nowrap;
        line-height: 1.6;
        font-size: 1.125rem;
      }
      .text-group {
        grid-column: 2 / 3;
      }
      .text-group p {
        margin: 0;
        line-height: 1.6;
      }
      .translation {
        font-size: 1.125rem;
        font-weight: 500;
        color: var(--text-primary);
        display: flex;
        align-items: baseline;
        gap: 8px;
        opacity: 0.6;
      }
      .translation.finalized {
        opacity: 1;
      }
      .transcription {
        font-size: 0.9rem;
        color: var(--text-secondary);
        opacity: 0.6;
      }
      .transcription.finalized {
        opacity: 1;
      }
      .timestamp-display {
        font-size: 0.75rem;
        color: var(--text-secondary);
        font-family: monospace;
        white-space: nowrap;
        margin-left: auto;
        padding-left: 12px;
      }
      .spinner {
        display: inline-block;
        flex-shrink: 0;
        width: 14px;
        height: 14px;
        border: 2px solid var(--spinner-track);
        border-top-color: var(--spinner-thumb);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        vertical-align: middle;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="header-container">
      <h1>Live Transcription & Translation</h1>
      <div class="status-grid">
        <div class="status-group">
          <div
            id="transcription-indicator"
            class="status-indicator connecting"
          ></div>
          <span>Transcription</span>
        </div>
        <div class="status-group">
          <div
            id="translation-indicator"
            class="status-indicator connecting"
          ></div>
          <span>Translation</span>
        </div>
      </div>
    </div>
    <div class="transcript-container">
      <div id="linesTranscript" class="output"></div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const outputEl = document.getElementById("linesTranscript");

        function updateUI(message) {
          if (!message.id) return;

          const isTranscription = message.id.startsWith("t-");
          const sentenceNum = message.id.split("-")[1];
          const pairId = `pair-${sentenceNum}`;
          const targetId = message.id;

          let pairContainer = document.getElementById(pairId);

          if (!pairContainer) {
            pairContainer = document.createElement("div");
            pairContainer.className = "sentence-pair";
            pairContainer.id = pairId;

            pairContainer.innerHTML = `
              <div class="speaker-name"></div>
              <div class="text-group">
                <p class="translation" id="tr-${sentenceNum}">
                  <span class="spinner"></span>
                  <span class="text-content"></span>
                  <span class="timestamp-display"></span>
                </p>
                <p class="transcription" id="t-${sentenceNum}">
                  <span class="text-content"></span>
                </p>
              </div>
            `;
            outputEl.appendChild(pairContainer);
          }

          const speakerNameEl = pairContainer.querySelector(".speaker-name");
          if (speakerNameEl && message.userName && !speakerNameEl.textContent) {
            speakerNameEl.textContent = `${message.userName}:`;
          }

          const targetEl = document.getElementById(targetId);
          const textContentEl = targetEl.querySelector(".text-content");
          if (textContentEl) {
            textContentEl.textContent = message.data;
          }

          if (message.type === "final") {
            targetEl.classList.add("finalized");
            if (!isTranscription) {
              const spinner = targetEl.querySelector(".spinner");
              if (spinner) spinner.remove();
              if (message.timestamp) {
                const timestampNode =
                  targetEl.querySelector(".timestamp-display");
                if (timestampNode) {
                  const d = new Date(message.timestamp);
                  timestampNode.textContent = `[${d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false })}]`;
                }
              }
            }
          }
          outputEl.parentElement.scrollTop =
            outputEl.parentElement.scrollHeight;
        }

        function connectWebSocket(config) {
          const ws = new WebSocket(config.url);
          ws.onopen = () => {
            config.indicatorEl.className = "status-indicator connected";
          };
          ws.onerror = (error) =>
            console.error(`WebSocket Error for ${config.name}:`, error);
          ws.onclose = () => {
            config.indicatorEl.className = "status-indicator disconnected";
            setTimeout(() => {
              config.indicatorEl.className = "status-indicator connecting";
              connectWebSocket(config);
            }, 5000);
          };
          ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            updateUI(message);
          };
        }
        connectWebSocket({
          name: "Transcription",
          url: "{{ transcription_url }}",
          indicatorEl: document.getElementById("transcription-indicator"),
        });
        connectWebSocket({
          name: "Translation",
          url: "{{ translation_url }}",
          indicatorEl: document.getElementById("translation-indicator"),
        });
      });
    </script>
  </body>
</html>
