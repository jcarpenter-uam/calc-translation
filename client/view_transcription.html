<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Real-Time Viewer</title>
    <style>
      :root {
        --bg: #ffffff;
        --text: #111111;
        --muted: #666666;
        --border: #e5e5e5;
        --chip-bg: rgba(0, 0, 0, 0.04);
        --chip-text: #000000;
        --spinner-border: #8d8d8d5c;
        --spinner-top: #b0b0b0;
        --silence-bg: #f3f3f3;
        --loading-bg: rgba(255, 77, 77, 0.06);
        --button-bg: #ffffff;
        --button-border: #e9e9e9;
        --wave-stroke: #000000;
        --label-dia-text: #868686;
        --label-trans-text: #111111;
      }

      @media (prefers-color-scheme: dark) {
        :root:not([data-theme="light"]) {
          --bg: #0b0b0b;
          --text: #e6e6e6;
          --muted: #9aa0a6;
          --border: #333333;
          --chip-bg: rgba(255, 255, 255, 0.08);
          --chip-text: #e6e6e6;
          --spinner-border: #555555;
          --spinner-top: #dddddd;
          --silence-bg: #1a1a1a;
          --loading-bg: rgba(255, 77, 77, 0.12);
          --button-bg: #111111;
          --button-border: #333333;
          --wave-stroke: #e6e6e6;
          --label-dia-text: #b3b3b3;
          --label-trans-text: #ffffff;
        }
      }

      :root[data-theme="dark"] {
        --bg: #0b0b0b;
        --text: #e6e6e6;
        --muted: #9aa0a6;
        --border: #333333;
        --chip-bg: rgba(255, 255, 255, 0.08);
        --chip-text: #e6e6e6;
        --spinner-border: #555555;
        --spinner-top: #dddddd;
        --silence-bg: #1a1a1a;
        --loading-bg: rgba(255, 77, 77, 0.12);
        --button-bg: #111111;
        --button-border: #333333;
        --wave-stroke: #e6e6e6;
        --label-dia-text: #b3b3b3;
        --label-trans-text: #ffffff;
      }

      :root[data-theme="light"] {
        --bg: #ffffff;
        --text: #111111;
        --muted: #666666;
        --border: #e5e5e5;
        --chip-bg: rgba(0, 0, 0, 0.04);
        --chip-text: #000000;
        --spinner-border: #8d8d8d5c;
        --spinner-top: #b0b0b0;
        --silence-bg: #f3f3f3;
        --loading-bg: rgba(255, 77, 77, 0.06);
        --button-bg: #ffffff;
        --button-border: #e9e9e9;
        --wave-stroke: #000000;
        --label-dia-text: #868686;
        --label-trans-text: #111111;
      }

      body {
        font-family:
          ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji",
          "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        margin: 0;
        text-align: center;
        background-color: var(--bg);
        color: var(--text);
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .header-container {
        position: sticky;
        top: 0;
        background-color: var(--bg);
        z-index: 100;
        padding: 20px;
        border-bottom: 1px solid var(--border);
      }
      .transcript-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      .transcript-container::-webkit-scrollbar {
        display: none;
      }
      #linesTranscript {
        margin: 0 auto;
        max-width: 700px;
        text-align: left;
        font-size: 16px;
      }
      .status-bar {
        padding: 10px;
        margin-bottom: 20px;
        border-radius: 5px;
        text-align: center;
        font-weight: bold;
        transition: background-color 0.3s ease;
      }
      .connecting {
        background-color: #f39c12;
        color: #111;
      }
      .connected {
        background-color: #2ecc71;
        color: #111;
      }
      .disconnected {
        background-color: #e74c3c;
        color: #fff;
      }
      .output span {
        transition: opacity 0.3s ease-in-out;
        opacity: 0.6;
      }
      .output span.finalized {
        opacity: 1;
      }
      .spinner {
        display: inline-block;
        width: 8px;
        height: 8px;
        border: 2px solid var(--spinner-border);
        border-top: 2px solid var(--spinner-top);
        border-radius: 50%;
        animation: spin 0.7s linear infinite;
        vertical-align: middle;
        margin-bottom: 2px;
        margin-right: 5px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="header-container">
      <h1>Live Transcription & Translation</h1>
      <div id="transcription-status" class="status-bar connecting">
        Connecting to Transcription...
      </div>
      <div id="translation-status" class="status-bar connecting">
        Connecting to Translation...
      </div>
    </div>
    <div class="transcript-container">
      <div id="linesTranscript" class="output"></div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        function connectWebSocket(config) {
          const ws = new WebSocket(config.url);

          ws.onopen = () => {
            console.log(`Connection opened for: ${config.url}`);
            config.statusEl.textContent = `Connected to ${config.name}`;
            config.statusEl.className = "status-bar connected";
          };

          ws.onerror = (error) => {
            console.error(`WebSocket Error for ${config.url}:`, error);
          };

          ws.onclose = () => {
            console.log(`Connection closed for ${config.url}. Reconnecting...`);
            config.statusEl.textContent = `Disconnected from ${config.name}. Retrying...`;
            config.statusEl.className = "status-bar disconnected";
            setTimeout(() => connectWebSocket(config), 5000);
          };

          ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            if (!message.id) return;

            let sentenceEl = document.getElementById(message.id);
            let textNode;

            if (!sentenceEl) {
              sentenceEl = document.createElement("span");
              sentenceEl.id = message.id;

              const lineContainer = document.createElement("p");

              const label = document.createElement("strong");
              label.textContent = `${config.name}: `;
              lineContainer.appendChild(label);

              const spinner = document.createElement("span");
              spinner.className = "spinner";
              sentenceEl.appendChild(spinner);

              textNode = document.createElement("span");
              sentenceEl.appendChild(textNode);

              lineContainer.appendChild(sentenceEl);
              config.outputEl.appendChild(lineContainer);
            } else {
              textNode = sentenceEl.lastChild;
            }

            textNode.textContent = message.data;

            if (message.type === "final") {
              sentenceEl.classList.add("finalized");
              const spinner = sentenceEl.querySelector(".spinner");
              if (spinner) {
                spinner.remove();
              }
            }

            config.outputEl.parentElement.scrollTop =
              config.outputEl.parentElement.scrollHeight;
          };
        }

        connectWebSocket({
          name: "Transcription",
          url: "ws://localhost:8000/ws/view_transcription",
          statusEl: document.getElementById("transcription-status"),
          outputEl: document.getElementById("linesTranscript"),
        });

        connectWebSocket({
          name: "Translation",
          url: "ws://localhost:8000/ws/view_translation",
          statusEl: document.getElementById("translation-status"),
          outputEl: document.getElementById("linesTranscript"),
        });
      });
    </script>
  </body>
</html>
