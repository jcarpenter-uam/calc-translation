<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Real-Time Viewer</title>
    <style>
      :root {
        --bg: #ffffff;
        --text: #111111;
        --muted: #666666;
        --border: #e5e5e5;
        --chip-bg: rgba(0, 0, 0, 0.04);
        --chip-text: #000000;
        --spinner-border: #8d8d8d5c;
        --spinner-top: #b0b0b0;
      }

      @media (prefers-color-scheme: dark) {
        :root:not([data-theme="light"]) {
          --bg: #0b0b0b;
          --text: #e6e6e6;
          --muted: #9aa0a6;
          --border: #333333;
          --chip-bg: rgba(255, 255, 255, 0.08);
          --chip-text: #e6e6e6;
          --spinner-border: #555555;
          --spinner-top: #dddddd;
        }
      }

      body {
        font-family:
          ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji",
          "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        margin: 0;
        text-align: center;
        background-color: var(--bg);
        color: var(--text);
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .header-container {
        position: sticky;
        top: 0;
        background-color: var(--bg);
        z-index: 100;
        padding: 20px;
        border-bottom: 1px solid var(--border);
      }
      .transcript-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      .transcript-container::-webkit-scrollbar {
        display: none;
      }
      #linesTranscript {
        margin: 0 auto;
        max-width: 700px;
        text-align: left;
        font-size: 16px;
      }
      .status-bar {
        padding: 10px;
        margin-bottom: 20px;
        border-radius: 5px;
        text-align: center;
        font-weight: bold;
        transition: background-color 0.3s ease;
      }
      .connecting {
        background-color: #f39c12;
        color: #111;
      }
      .connected {
        background-color: #2ecc71;
        color: #111;
      }
      .disconnected {
        background-color: #e74c3c;
        color: #fff;
      }

      .sentence-pair {
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--border);
      }
      .sentence-pair:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }
      .sentence-pair p {
        margin: 0;
        line-height: 1.5;
      }
      .translation {
        font-size: 1.1em;
        font-weight: 500;
        color: var(--text);
        display: flex;
        align-items: baseline;
      }
      .translation.finalized {
        opacity: 1;
      }
      .transcription {
        font-size: 0.85em;
        color: var(--muted);
        margin-top: 8px;
        opacity: 0.7;
      }
      .transcription.finalized {
        opacity: 1;
      }
      .timestamp-display {
        font-size: 0.75em;
        color: var(--muted);
        margin-left: 10px;
        font-family: monospace;
      }
      .spinner {
        display: inline-block;
        flex-shrink: 0;
        width: 12px;
        height: 12px;
        border: 2px solid var(--spinner-border);
        border-top: 2px solid var(--spinner-top);
        border-radius: 50%;
        animation: spin 0.7s linear infinite;
        vertical-align: middle;
        margin-right: 8px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="header-container">
      <h1>Live Transcription & Translation</h1>
      <div id="transcription-status" class="status-bar connecting">
        Connecting to Transcription...
      </div>
      <div id="translation-status" class="status-bar connecting">
        Connecting to Translation...
      </div>
    </div>
    <div class="transcript-container">
      <div id="linesTranscript" class="output"></div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const outputEl = document.getElementById("linesTranscript");

        function updateUI(message) {
          if (!message.id) return;

          const isTranscription = message.id.startsWith("t-");
          const sentenceNum = message.id.split("-")[1];
          const pairId = `pair-${sentenceNum}`;
          const targetId = message.id;

          let pairContainer = document.getElementById(pairId);

          if (!pairContainer) {
            pairContainer = document.createElement("div");
            pairContainer.className = "sentence-pair";
            pairContainer.id = pairId;

            const translationP = document.createElement("p");
            translationP.className = "translation";
            translationP.id = `tr-${sentenceNum}`;
            translationP.innerHTML = `<span class="spinner"></span><span class="text-content"></span><span class="timestamp-display"></span>`;

            const transcriptionP = document.createElement("p");
            transcriptionP.className = "transcription";
            transcriptionP.id = `t-${sentenceNum}`;

            pairContainer.appendChild(translationP);
            pairContainer.appendChild(transcriptionP);
            outputEl.appendChild(pairContainer);
          }

          const targetEl = document.getElementById(targetId);
          const textContentEl = isTranscription
            ? targetEl
            : targetEl.querySelector(".text-content");

          if (textContentEl) {
            textContentEl.textContent = message.data;
          }

          if (message.type === "final") {
            targetEl.classList.add("finalized");

            if (!isTranscription) {
              const spinner = targetEl.querySelector(".spinner");
              if (spinner) spinner.remove();

              if (message.timestamp) {
                const timestampNode =
                  targetEl.querySelector(".timestamp-display");
                if (timestampNode) {
                  const d = new Date(message.timestamp);
                  timestampNode.textContent = `[${d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false })}]`;
                }
              }
            }
          }

          // Auto-scroll to the bottom
          outputEl.parentElement.scrollTop =
            outputEl.parentElement.scrollHeight;
        }

        function connectWebSocket(config) {
          const ws = new WebSocket(config.url);

          ws.onopen = () => {
            config.statusEl.textContent = `Connected to ${config.name}`;
            config.statusEl.className = "status-bar connected";
          };
          ws.onerror = (error) =>
            console.error(`WebSocket Error for ${config.url}:`, error);
          ws.onclose = () => {
            config.statusEl.textContent = `Disconnected from ${config.name}. Retrying...`;
            config.statusEl.className = "status-bar disconnected";
            setTimeout(() => connectWebSocket(config), 5000);
          };
          ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            updateUI(message);
          };
        }

        connectWebSocket({
          name: "Transcription",
          url: "ws://localhost:8000/ws/view_transcription",
          statusEl: document.getElementById("transcription-status"),
        });

        connectWebSocket({
          name: "Translation",
          url: "ws://localhost:8000/ws/view_translation",
          statusEl: document.getElementById("translation-status"),
        });
      });
    </script>
  </body>
</html>
